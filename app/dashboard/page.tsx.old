"use client";

import { useState } from "react";
import { supabase } from "@/lib/supabase";

// –¢–∏–ø–∏ –¥–ª—è TypeScript
type VariantModule = {
  id: string;
  name: string;
};

type Program = {
  id: string;
  classes: number[];
  description: string;
  hasVariant: boolean;
  variantModules?: VariantModule[];
  variantRequired?: number;
};

type Programs = {
  [subject: string]: {
    [program: string]: Program;
  };
};

const PROGRAMS: Programs = {
  "–§—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞": {
    "–ù–£–® 5-9 –∫–ª–∞—Å–∏": {
      id: "fizkultura-nush-5-9",
      classes: [5, 6, 7, 8, 9],
      description: "–ë–∞–∑–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –ù–£–®",
      hasVariant: false,
    },
    "10-11 –∫–ª–∞—Å–∏ (—Ä—ñ–≤–µ–Ω—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É)": {
      id: "fizkultura-10-11-standart",
      classes: [10, 11],
      description: "2 –≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å",
      hasVariant: true,
      variantModules: [
        { id: "basketball", name: "–ë–∞—Å–∫–µ—Ç–±–æ–ª" },
        { id: "volleyball", name: "–í–æ–ª–µ–π–±–æ–ª" },
        { id: "football", name: "–§—É—Ç–±–æ–ª" },
        { id: "athletics", name: "–õ–µ–≥–∫–∞ –∞—Ç–ª–µ—Ç–∏–∫–∞" },
        { id: "gymnastics", name: "–ì—ñ–º–Ω–∞—Å—Ç–∏–∫–∞" },
        { id: "badminton", name: "–ë–∞–¥–º—ñ–Ω—Ç–æ–Ω" },
      ],
      variantRequired: 2,
    },
    "10-11 –∫–ª–∞—Å–∏ (–ø—Ä–æ—Ñ—ñ–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å)": {
      id: "fizkultura-10-11-profil",
      classes: [10, 11],
      description: "4-5 –≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å, –ø–æ–≥–ª–∏–±–ª–µ–Ω–µ –≤–∏–≤—á–µ–Ω–Ω—è",
      hasVariant: true,
      variantModules: [
        { id: "basketball", name: "–ë–∞—Å–∫–µ—Ç–±–æ–ª (–ø–æ–≥–ª–∏–±–ª–µ–Ω–∏–π)" },
        { id: "volleyball", name: "–í–æ–ª–µ–π–±–æ–ª (–ø–æ–≥–ª–∏–±–ª–µ–Ω–∏–π)" },
        { id: "football", name: "–§—É—Ç–±–æ–ª (–ø–æ–≥–ª–∏–±–ª–µ–Ω–∏–π)" },
        { id: "athletics", name: "–õ–µ–≥–∫–∞ –∞—Ç–ª–µ—Ç–∏–∫–∞ (–ø–æ–≥–ª–∏–±–ª–µ–Ω–∞)" },
        { id: "gymnastics", name: "–ì—ñ–º–Ω–∞—Å—Ç–∏–∫–∞ (–ø–æ–≥–ª–∏–±–ª–µ–Ω–∞)" },
      ],
      variantRequired: 1,
    },
  },
  "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞": {
    "–ù–£–® 5-9 –∫–ª–∞—Å–∏": {
      id: "ukrainian-nush-5-9",
      classes: [5, 6, 7, 8, 9],
      description: "–ë–∞–∑–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –ù–£–®",
      hasVariant: false,
    },
    "10-11 –∫–ª–∞—Å–∏ (—Ä—ñ–≤–µ–Ω—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É)": {
      id: "ukrainian-10-11-standard",
      classes: [10, 11],
      description: "2-3 –≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å",
      hasVariant: false,
    },
    "10-11 –∫–ª–∞—Å–∏ (–ø—Ä–æ—Ñ—ñ–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å)": {
      id: "ukrainian-10-11-profile",
      classes: [10, 11],
      description: "4-5 –≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å, –ø–æ–≥–ª–∏–±–ª–µ–Ω–µ –≤–∏–≤—á–µ–Ω–Ω—è",
      hasVariant: false,
    },
  },
};

export default function Dashboard() {
  const [formData, setFormData] = useState({
    subject: "–§—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞",
    program: "–ù–£–® 5-9 –∫–ª–∞—Å–∏",
    programId: "fizkultura-nush-5-9",
    class: "5",
    semester: "0",
    weekdays: "–ü–Ω,–°—Ä",
    startDate: "2024-09-01",
    schoolYear: "2024/2025",
    teacherName: "",
    teacherCategory: "",
    schoolName: "",
    variantModules: [] as string[],
  });

  const [loading, setLoading] = useState(false);

  const currentProgram = PROGRAMS[formData.subject]?.[formData.program];

  const handleProgramChange = (program: string) => {
    const programData = PROGRAMS[formData.subject]?.[program];
    if (!programData) return;

    setFormData({
      ...formData,
      program,
      programId: programData.id,
      class: programData.classes[0].toString(),
      variantModules: [],
    });
  };

  const handleVariantToggle = (moduleId: string) => {
    const isSelected = formData.variantModules.includes(moduleId);
    let newModules: string[];

    if (isSelected) {
      newModules = formData.variantModules.filter((id) => id !== moduleId);
    } else {
      newModules = [...formData.variantModules, moduleId];
    }

    setFormData({ ...formData, variantModules: newModules });
  };

  const handleGenerate = async () => {
    if (currentProgram?.hasVariant) {
      const required = currentProgram.variantRequired || 1;
      if (formData.variantModules.length < required) {
        alert(`–û–±–µ—Ä—ñ—Ç—å –º—ñ–Ω—ñ–º—É–º ${required} –º–æ–¥—É–ª—ñ –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è`);
        return;
      }
    }

    setLoading(true);
    try {
      // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      
      if (userError || !user) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.");
        window.location.href = "/login";
        return;
      }

      const response = await fetch("/api/documents/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...formData,
          userId: user.id
        }),
      });

      const data = await response.json();

      if (!response.ok) throw new Error(data.error || "–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó");

      alert("‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø—ñ—à–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ!");
      setFormData({ ...formData, variantModules: [] });
    } catch (error: any) {
      alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-2xl mx-auto">
        <div className="bg-white rounded-lg shadow p-6">
          <h1 className="text-3xl font-bold mb-6">–ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∏–π –ø–ª–∞–Ω</h1>

          <div className="space-y-4">
            <div>
              <label className="block font-medium mb-2">–ü—Ä–µ–¥–º–µ—Ç</label>
              <select
                value={formData.subject}
                onChange={(e) => setFormData({ ...formData, subject: e.target.value })}
                className="w-full border rounded px-3 py-2"
              >
                <option>–§—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞</option>
              </select>
            </div>

            <div>
              <label className="block font-medium mb-2">–ü—Ä–æ–≥—Ä–∞–º–∞</label>
              <select
                value={formData.program}
                onChange={(e) => handleProgramChange(e.target.value)}
                className="w-full border rounded px-3 py-2"
              >
                {Object.keys(PROGRAMS[formData.subject] || {}).map((prog) => (
                  <option key={prog} value={prog}>
                    {prog}
                  </option>
                ))}
              </select>
              {currentProgram?.description && (
                <p className="text-sm text-gray-500 mt-1">üí° {currentProgram.description}</p>
              )}
            </div>

            <div>
              <label className="block font-medium mb-2">–ö–ª–∞—Å</label>
              <select
                value={formData.class}
                onChange={(e) => setFormData({ ...formData, class: e.target.value })}
                className="w-full border rounded px-3 py-2"
              >
                {currentProgram?.classes.map((cls: number) => (
                  <option key={cls} value={cls}>
                    {cls} –∫–ª–∞—Å
                  </option>
                ))}
              </select>
            </div>

            {currentProgram?.hasVariant && currentProgram.variantModules && (
              <div className="p-4 bg-blue-50 border border-blue-200 rounded">
                <label className="block font-medium mb-2">
                  üéØ –û–±–µ—Ä—ñ—Ç—å –º–æ–¥—É–ª—ñ –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è (–º—ñ–Ω—ñ–º—É–º {currentProgram.variantRequired || 1})
                </label>
                <div className="space-y-2">
                  {currentProgram.variantModules.map((module: VariantModule) => (
                    <label
                      key={module.id}
                      className="flex items-center cursor-pointer hover:bg-blue-100 p-2 rounded"
                    >
                      <input
                        type="checkbox"
                        checked={formData.variantModules.includes(module.id)}
                        onChange={() => handleVariantToggle(module.id)}
                        className="mr-3 w-5 h-5"
                      />
                      <span>{module.name}</span>
                    </label>
                  ))}
                </div>
                <p className="text-sm text-gray-600 mt-2">
                  –í–∏–±—Ä–∞–Ω–æ: {formData.variantModules.length} / {currentProgram.variantModules.length}
                </p>
              </div>
            )}

            <div>
              <label className="block font-medium mb-2">–°–µ–º–µ—Å—Ç—Ä</label>
              <select
                value={formData.semester}
                onChange={(e) => setFormData({ ...formData, semester: e.target.value })}
                className="w-full border rounded px-3 py-2"
              >
                <option value="0">–û–±–∏–¥–≤–∞ —Å–µ–º–µ—Å—Ç—Ä–∏</option>
                <option value="1">–ü–µ—Ä—à–∏–π —Å–µ–º–µ—Å—Ç—Ä</option>
                <option value="2">–î—Ä—É–≥–∏–π —Å–µ–º–µ—Å—Ç—Ä</option>
              </select>
            </div>

            <div>
              <label className="block font-medium mb-2">–î–Ω—ñ —Ç–∏–∂–Ω—è (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
              <input
                type="text"
                value={formData.weekdays}
                onChange={(e) => setFormData({ ...formData, weekdays: e.target.value })}
                placeholder="–ü–Ω,–°—Ä"
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block font-medium mb-2">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
              <input
                type="date"
                value={formData.startDate}
                onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block font-medium mb-2">–ù–∞–≤—á–∞–ª—å–Ω–∏–π —Ä—ñ–∫</label>
              <input
                type="text"
                value={formData.schoolYear}
                onChange={(e) => setFormData({ ...formData, schoolYear: e.target.value })}
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block font-medium mb-2">–ü–Ü–ë –≤—á–∏—Ç–µ–ª—è</label>
              <input
                type="text"
                value={formData.teacherName}
                onChange={(e) => setFormData({ ...formData, teacherName: e.target.value })}
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block font-medium mb-2">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –≤—á–∏—Ç–µ–ª—è</label>
              <input
                type="text"
                value={formData.teacherCategory}
                onChange={(e) => setFormData({ ...formData, teacherCategory: e.target.value })}
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <div>
              <label className="block font-medium mb-2">–ù–∞–∑–≤–∞ —à–∫–æ–ª–∏</label>
              <input
                type="text"
                value={formData.schoolName}
                onChange={(e) => setFormData({ ...formData, schoolName: e.target.value })}
                className="w-full border rounded px-3 py-2"
              />
            </div>

            <button
              onClick={handleGenerate}
              disabled={loading}
              className="w-full bg-orange-500 text-white py-3 rounded-lg font-medium hover:bg-orange-600 disabled:bg-gray-400 transition"
            >
              {loading ? "–ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è..." : "–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–ª–∞–Ω"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
